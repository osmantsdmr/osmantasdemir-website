---
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/Navbar.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import ShareButtons from '../../components/ShareButtons.astro';
import Comments from '../../components/Comments.astro';
import RelatedPosts from '../../components/RelatedPosts.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import { getCollection } from 'astro:content';
import readingTime from 'reading-time';

export async function getStaticPaths() {
  const blogYazilari = await getCollection('blog');
  return blogYazilari.map((yazi) => ({
    params: { slug: yazi.slug },
    props: { yazi },
  }));
}

const { yazi } = Astro.props;
const { Content, headings } = await yazi.render();

// Okuma süresi hesapla
const stats = readingTime(yazi.body || '');
const okumaSuresi = Math.max(1, Math.ceil(stats.minutes));

// İlgili yazılar için tüm yazıları al
const tumYazilar = await getCollection('blog');

// Sadece h2 ve h3'leri filtrele (TOC için)
const tocHeadings = headings.filter(h => h.depth === 2 || h.depth === 3);

// Schema.org BlogPosting
const schemaData = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": yazi.data.baslik,
  "description": yazi.data.ozet,
  "image": yazi.data.kapakGorseli || "/images/og-default.jpg",
  "author": {
    "@type": "Person",
    "name": yazi.data.yazar || "Osman Taşdemir"
  },
  "datePublished": yazi.data.tarih.toISOString(),
  "publisher": {
    "@type": "Person",
    "name": "Osman Taşdemir"
  }
};
---

<Layout 
  title={`${yazi.data.baslik} | Osman Taşdemir`}
  description={yazi.data.metaDescription || yazi.data.ozet}
  image={yazi.data.kapakGorseli}
  type="article"
  publishedTime={yazi.data.tarih}
  tags={yazi.data.etiketler}
>
  <Navbar />
  
  <!-- Schema.org yapılandırılmış veri -->
  <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />
  
  <!-- Okuma ilerleme çubuğu -->
  <div id="progress-bar" class="progress-bar"></div>
  
  <main class="blog-main">
    <!-- Hero Section -->
    <header class="blog-header">
      <div class="header-container">
        <!-- Breadcrumb -->
        <Breadcrumb 
          items={[
            { label: 'Ana Sayfa', href: '/' },
            { label: 'Blog', href: '/blog' },
            { label: yazi.data.baslik }
          ]} 
        />
        
        <!-- Kategori -->
        {yazi.data.kategori && (
          <a href={`/blog/kategori/${yazi.data.kategori.toLowerCase().replace(/\s+/g, '-')}`} class="category-badge">
            {yazi.data.kategori}
          </a>
        )}
        
        <!-- Başlık -->
        <h1 class="blog-title">{yazi.data.baslik}</h1>
        
        <!-- Özet -->
        <p class="blog-summary">{yazi.data.ozet}</p>
        
        <!-- Meta bilgiler -->
        <div class="blog-meta">
          <div class="meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <time datetime={yazi.data.tarih.toISOString()}>
              {new Date(yazi.data.tarih).toLocaleDateString('tr-TR', { year: 'numeric', month: 'long', day: 'numeric' })}
            </time>
          </div>
          <div class="meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>{okumaSuresi} dk okuma</span>
          </div>
          <div class="meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            <span>{yazi.data.yazar || 'Osman Taşdemir'}</span>
          </div>
        </div>
        
        <!-- Etiketler -->
        {yazi.data.etiketler && yazi.data.etiketler.length > 0 && (
          <div class="tags-container">
            {yazi.data.etiketler.map((etiket) => (
              <a href={`/blog/etiket/${etiket.toLowerCase().replace(/\s+/g, '-')}`} class="tag">
                #{etiket}
              </a>
            ))}
          </div>
        )}
      </div>
    </header>
    
    <!-- Kapak görseli -->
    {yazi.data.kapakGorseli && (
      <div class="cover-image-container">
        <img 
          src={yazi.data.kapakGorseli} 
          alt={yazi.data.baslik}
          class="cover-image"
          loading="eager"
        />
      </div>
    )}
    
    <!-- Ana içerik alanı -->
    <article class="blog-content-wrapper">
      <div class="content-layout">
        
        <!-- Sol: İçindekiler (Desktop) -->
        {tocHeadings.length > 2 && (
          <aside class="toc-sidebar">
            <div class="toc-sticky">
              <TableOfContents headings={headings} />
            </div>
          </aside>
        )}
        
        <!-- Sağ: Ana içerik -->
        <div class="main-content">
          
          <!-- Mobil İçindekiler -->
          {tocHeadings.length > 2 && (
            <details class="toc-mobile">
              <summary>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
                </svg>
                İçindekiler
                <svg class="chevron" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </summary>
              <div class="toc-mobile-content">
                <TableOfContents headings={headings} mobile={true} />
              </div>
            </details>
          )}
          
          <!-- İçerik -->
          <div class="prose">
            <Content />
          </div>
          
          <!-- Sosyal paylaşım -->
          <section class="share-section">
            <ShareButtons 
              title={yazi.data.baslik}
              url={Astro.url.href}
            />
          </section>
          
          <!-- Yazar kutusu -->
          <section class="author-box">
            <img 
              src="/images/osman-tasdemir.jpg" 
              alt="Osman Taşdemir"
              class="author-image"
              onerror="this.style.display='none'"
            />
            <div class="author-info">
              <h3>Osman Taşdemir</h3>
              <p class="author-title">CBS Uzmanı & Otomasyon Geliştiricisi</p>
              <p class="author-bio">
                İzmir Bakırçay Üniversitesi Coğrafya bölümü. CBS, uzaktan algılama ve otomasyon alanlarında projeler geliştiriyorum.
              </p>
            </div>
          </section>
          
          <!-- İlgili yazılar -->
          <RelatedPosts 
            currentSlug={yazi.slug}
            currentKategori={yazi.data.kategori}
            tumYazilar={tumYazilar}
          />
          
          <!-- Yorumlar -->
          <Comments pageId={yazi.slug} pageTitle={yazi.data.baslik} />
          
          <!-- Geri dön -->
          <div class="back-section">
            <a href="/blog" class="back-button">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
              </svg>
              Tüm Yazılar
            </a>
          </div>
          
        </div>
      </div>
    </article>
  </main>
</Layout>

<style>
  /* Progress bar */
  .progress-bar {
    position: fixed;
    top: 0;
    left: 0;
    height: 3px;
    background: linear-gradient(90deg, #7c9a5e, #9ab87a);
    z-index: 100;
    width: 0%;
    transition: width 0.1s ease-out;
  }
  
  /* Main */
  .blog-main {
    padding-top: 80px;
    background: #2a2a32;
    min-height: 100vh;
  }
  
  /* Header */
  .blog-header {
    background: linear-gradient(180deg, #37353E 0%, #2a2a32 100%);
    padding: 40px 20px 60px;
  }
  
  .header-container {
    max-width: 800px;
    margin: 0 auto;
    text-align: center;
  }
  
  .category-badge {
    display: inline-block;
    padding: 6px 16px;
    margin-bottom: 20px;
    font-size: 13px;
    font-weight: 500;
    background: linear-gradient(135deg, #57564F 0%, #4a4a42 100%);
    color: #D3DAD9;
    border-radius: 20px;
    text-decoration: none;
    transition: all 0.2s ease;
  }
  
  .category-badge:hover {
    background: linear-gradient(135deg, #6a6960 0%, #57564F 100%);
    transform: translateY(-1px);
  }
  
  .blog-title {
    font-size: clamp(28px, 5vw, 42px);
    font-weight: 700;
    color: #fff;
    margin-bottom: 20px;
    line-height: 1.2;
  }
  
  .blog-summary {
    font-size: 18px;
    color: #a0a0a0;
    max-width: 650px;
    margin: 0 auto 24px;
    line-height: 1.6;
  }
  
  .blog-meta {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 24px;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }
  
  .meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #7a7a7a;
  }
  
  .meta-item svg {
    opacity: 0.7;
  }
  
  .tags-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  .tag {
    font-size: 13px;
    padding: 4px 12px;
    background: rgba(87, 86, 79, 0.3);
    color: #9a9a9a;
    border-radius: 4px;
    text-decoration: none;
    transition: all 0.2s ease;
  }
  
  .tag:hover {
    background: rgba(87, 86, 79, 0.5);
    color: #D3DAD9;
  }
  
  /* Cover image */
  .cover-image-container {
    max-width: 900px;
    margin: -30px auto 0;
    padding: 0 20px;
  }
  
  .cover-image {
    width: 100%;
    height: auto;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
  }
  
  /* Content wrapper */
  .blog-content-wrapper {
    padding: 60px 20px 80px;
  }
  
  .content-layout {
    max-width: 1400px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 80px;
  }
  
  @media (max-width: 1024px) {
    .content-layout {
      grid-template-columns: 1fr;
      gap: 0;
    }
  }
  
  /* TOC Sidebar */
  .toc-sidebar {
    display: none;
  }
  
  @media (min-width: 1024px) {
    .toc-sidebar {
      display: block;
      position: relative;
    }
  }
  
  .toc-sticky {
    position: sticky;
    top: 100px;
    max-height: calc(100vh - 140px);
    overflow-y: auto;
  }
  
  .toc-sticky::-webkit-scrollbar {
    width: 4px;
  }
  
  .toc-sticky::-webkit-scrollbar-thumb {
    background: rgba(87, 86, 79, 0.5);
    border-radius: 4px;
  }
  
  /* Main content */
  .main-content {
    min-width: 0;
    max-width: 800px;
  }
  
  /* Mobile TOC */
  .toc-mobile {
    display: block;
    background: linear-gradient(135deg, #3a3a42 0%, #2d2d35 100%);
    border-radius: 12px;
    margin-bottom: 40px;
    border: 1px solid rgba(87, 86, 79, 0.3);
  }
  
  @media (min-width: 1024px) {
    .toc-mobile {
      display: none;
    }
  }
  
  .toc-mobile summary {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 16px 20px;
    cursor: pointer;
    font-weight: 500;
    color: #D3DAD9;
    list-style: none;
  }
  
  .toc-mobile summary::-webkit-details-marker {
    display: none;
  }
  
  .toc-mobile summary .chevron {
    margin-left: auto;
    transition: transform 0.2s ease;
  }
  
  .toc-mobile[open] summary .chevron {
    transform: rotate(180deg);
  }
  
  .toc-mobile-content {
    padding: 0 20px 20px;
  }
  
  /* Prose - İçerik stilleri */
  .prose {
    color: #D3DAD9;
    font-size: 17px;
    line-height: 1.85;
  }
  
  /* Başlık linkleri normal renkte */
  .prose :global(h2 a),
  .prose :global(h3 a),
  .prose :global(h4 a) {
    color: inherit;
    text-decoration: none;
    border-bottom: none;
  }
  
  .prose :global(h2 a:hover),
  .prose :global(h3 a:hover),
  .prose :global(h4 a:hover) {
    color: inherit;
    border-bottom: none;
  }
  
  .prose :global(h2) {
    font-size: 28px;
    font-weight: 700;
    margin-top: 56px;
    margin-bottom: 20px;
    color: #fff;
    scroll-margin-top: 100px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(87, 86, 79, 0.3);
  }
  
  .prose :global(h3) {
    font-size: 22px;
    font-weight: 600;
    margin-top: 40px;
    margin-bottom: 16px;
    color: #e8e8e8;
    scroll-margin-top: 100px;
  }
  
  .prose :global(h4) {
    font-size: 18px;
    font-weight: 600;
    margin-top: 32px;
    margin-bottom: 12px;
    color: #d0d0d0;
    scroll-margin-top: 100px;
  }
  
  .prose :global(p) {
    margin-bottom: 24px;
    color: #c0c0c0;
  }
  
  .prose :global(strong) {
    font-weight: 600;
    color: #fff;
  }
  
  .prose :global(em) {
    font-style: italic;
    color: #b8b8b8;
  }
  
  .prose :global(ul), .prose :global(ol) {
    margin-bottom: 24px;
    padding-left: 28px;
  }
  
  .prose :global(ul) {
    list-style-type: disc;
  }
  
  .prose :global(ol) {
    list-style-type: decimal;
  }
  
  .prose :global(li) {
    margin-bottom: 10px;
    color: #c0c0c0;
  }
  
  .prose :global(li::marker) {
    color: #7c9a5e;
  }
  
  .prose :global(a) {
    color: #8ab4f8;
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: all 0.2s ease;
  }
  
  .prose :global(a:hover) {
    color: #aecbfa;
    border-bottom-color: #aecbfa;
  }
  
  /* Inline kod */
  .prose :global(code:not(pre code)) {
    background: rgba(87, 86, 79, 0.4);
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.9em;
    font-family: 'Fira Code', 'SF Mono', 'Consolas', monospace;
    color: #e8c97a;
  }
  
  /* Kod blokları */
  .prose :global(pre) {
    background: #1a1a1f !important;
    padding: 24px;
    border-radius: 12px;
    overflow-x: auto;
    margin-bottom: 28px;
    border: 1px solid rgba(87, 86, 79, 0.3);
  }
  
  .prose :global(pre code) {
    font-size: 14px;
    line-height: 1.7;
    font-family: 'Fira Code', 'SF Mono', 'Consolas', monospace;
  }
  
  /* Blockquote */
  .prose :global(blockquote) {
    border-left: 4px solid #7c9a5e;
    padding: 20px 24px;
    margin: 32px 0;
    background: linear-gradient(135deg, rgba(124, 154, 94, 0.1) 0%, rgba(124, 154, 94, 0.05) 100%);
    border-radius: 0 12px 12px 0;
    font-style: italic;
    color: #b8b8b8;
  }
  
  .prose :global(blockquote p) {
    margin-bottom: 0;
  }
  
  /* Tablolar */
  .prose :global(table) {
    width: 100%;
    margin: 32px 0;
    border-collapse: collapse;
    font-size: 15px;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid rgba(87, 86, 79, 0.3);
  }
  
  .prose :global(thead) {
    background: linear-gradient(135deg, #3a3a42 0%, #2d2d35 100%);
  }
  
  .prose :global(th) {
    padding: 14px 18px;
    text-align: left;
    font-weight: 600;
    color: #D3DAD9;
    border-bottom: 2px solid rgba(87, 86, 79, 0.5);
  }
  
  .prose :global(td) {
    padding: 14px 18px;
    border-bottom: 1px solid rgba(87, 86, 79, 0.2);
    color: #b8b8b8;
  }
  
  .prose :global(tr:last-child td) {
    border-bottom: none;
  }
  
  .prose :global(tr:hover td) {
    background: rgba(87, 86, 79, 0.15);
  }
  
  /* Görseller */
  .prose :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 12px;
    margin: 32px 0;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
  }
  
  /* Yatay çizgi */
  .prose :global(hr) {
    border: none;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(87, 86, 79, 0.5), transparent);
    margin: 48px 0;
  }
  
  /* Sections */
  .share-section {
    margin-top: 56px;
    padding-top: 40px;
    border-top: 1px solid rgba(87, 86, 79, 0.3);
  }
  
  .author-box {
    margin-top: 40px;
    padding: 28px;
    background: linear-gradient(135deg, #3a3a42 0%, #2d2d35 100%);
    border-radius: 16px;
    display: flex;
    align-items: flex-start;
    gap: 20px;
    border: 1px solid rgba(87, 86, 79, 0.3);
  }
  
  .author-image {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
    border: 3px solid rgba(87, 86, 79, 0.3);
  }
  
  .author-info h3 {
    font-size: 18px;
    font-weight: 600;
    color: #fff;
    margin: 0 0 4px 0;
  }
  
  .author-title {
    font-size: 14px;
    color: #7c9a5e;
    margin: 0 0 12px 0;
  }
  
  .author-bio {
    font-size: 14px;
    color: #9a9a9a;
    margin: 0;
    line-height: 1.6;
  }
  
  .back-section {
    margin-top: 56px;
    padding-top: 40px;
    border-top: 1px solid rgba(87, 86, 79, 0.3);
  }
  
  .back-button {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    color: #D3DAD9;
    text-decoration: none;
    padding: 14px 28px;
    background: linear-gradient(135deg, #57564F 0%, #4a4a42 100%);
    border-radius: 10px;
    font-weight: 500;
    transition: all 0.2s ease;
  }
  
  .back-button:hover {
    background: linear-gradient(135deg, #6a6960 0%, #57564F 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
  }
</style>

<script is:inline>
  // Okuma ilerleme çubuğu
  const progressBar = document.getElementById('progress-bar');
  
  window.addEventListener('scroll', () => {
    const scrollTop = window.scrollY;
    const docHeight = document.documentElement.scrollHeight - window.innerHeight;
    const progress = (scrollTop / docHeight) * 100;
    
    if (progressBar) {
      progressBar.style.width = `${Math.min(progress, 100)}%`;
    }
  });
  
  // Kod kopyalama butonları
  document.querySelectorAll('.prose pre').forEach((pre) => {
    const wrapper = document.createElement('div');
    wrapper.style.position = 'relative';
    pre.parentNode.insertBefore(wrapper, pre);
    wrapper.appendChild(pre);
    
    const button = document.createElement('button');
    button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`;
    button.style.cssText = 'position: absolute; top: 12px; right: 12px; padding: 8px; background: rgba(87, 86, 79, 0.5); border: none; border-radius: 6px; color: #D3DAD9; cursor: pointer; opacity: 0; transition: all 0.2s;';
    
    wrapper.addEventListener('mouseenter', () => button.style.opacity = '1');
    wrapper.addEventListener('mouseleave', () => button.style.opacity = '0');
    
    button.addEventListener('click', async () => {
      const code = pre.querySelector('code');
      if (code) {
        try {
          await navigator.clipboard.writeText(code.textContent || '');
          button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
          button.style.background = 'rgba(124, 154, 94, 0.5)';
          setTimeout(() => {
            button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`;
            button.style.background = 'rgba(87, 86, 79, 0.5)';
          }, 2000);
        } catch (err) {
          console.error('Kopyalama başarısız:', err);
        }
      }
    });
    
    wrapper.appendChild(button);
  });
</script>