---
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/Navbar.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import ShareButtons from '../../components/ShareButtons.astro';
import Comments from '../../components/Comments.astro';
import RelatedPosts from '../../components/RelatedPosts.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import { getCollection } from 'astro:content';
import readingTime from 'reading-time';

export async function getStaticPaths() {
  const blogYazilari = await getCollection('blog');
  return blogYazilari.map((yazi) => ({
    params: { slug: yazi.slug },
    props: { yazi },
  }));
}

const { yazi } = Astro.props;
const { Content, headings } = await yazi.render();

// Okuma süresi hesapla
const stats = readingTime(yazi.body || '');
const okumaSuresi = Math.max(1, Math.ceil(stats.minutes));

// İlgili yazılar için tüm yazıları al
const tumYazilar = await getCollection('blog');

// Schema.org BlogPosting
const schemaData = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": yazi.data.baslik,
  "description": yazi.data.ozet,
  "image": yazi.data.kapakGorseli || "/images/og-default.jpg",
  "author": {
    "@type": "Person",
    "name": yazi.data.yazar || "Osman Taşdemir"
  },
  "datePublished": yazi.data.tarih.toISOString(),
  "publisher": {
    "@type": "Person",
    "name": "Osman Taşdemir"
  }
};
---

<Layout 
  title={`${yazi.data.baslik} | Osman Taşdemir`}
  description={yazi.data.metaDescription || yazi.data.ozet}
  image={yazi.data.kapakGorseli}
  type="article"
  publishedTime={yazi.data.tarih}
  tags={yazi.data.etiketler}
>
  <Navbar />
  
  <!-- Schema.org yapılandırılmış veri -->
  <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />
  
  <!-- Okuma ilerleme çubuğu -->
  <div id="progress-bar" style="position: fixed; top: 0; left: 0; height: 3px; background: linear-gradient(90deg, #57564F, #8a8a8a); z-index: 100; width: 0%; transition: width 0.1s;"></div>
  
  <main style="padding-top: 80px; background-color: #37353E; min-height: 100vh;">
    <article style="max-width: 900px; margin: 0 auto; padding: 40px 20px;">
      
      <!-- Breadcrumb -->
      <Breadcrumb 
        items={[
          { label: 'Ana Sayfa', href: '/' },
          { label: 'Blog', href: '/blog' },
          { label: yazi.data.baslik }
        ]} 
      />
      
      <!-- Header -->
      <header style="margin-bottom: 40px; text-align: center;">
        <!-- Kategori badge -->
        {yazi.data.kategori && (
          <a 
            href={`/blog/kategori/${yazi.data.kategori.toLowerCase().replace(/\s+/g, '-')}`}
            style="display: inline-block; padding: 6px 14px; margin-bottom: 16px; font-size: 13px; font-weight: 500; background: #57564F; color: #D3DAD9; border-radius: 20px; text-decoration: none; transition: background 0.2s;"
            class="kategori-badge"
          >
            {yazi.data.kategori}
          </a>
        )}
        
        <h1 style="font-size: 36px; font-weight: bold; color: #D3DAD9; margin-bottom: 16px; line-height: 1.3;">
          {yazi.data.baslik}
        </h1>
        
        <p style="font-size: 18px; color: #D3DAD9; opacity: 0.7; max-width: 650px; margin: 0 auto 20px;">
          {yazi.data.ozet}
        </p>
        
        <!-- Meta bilgiler -->
        <div style="display: flex; align-items: center; justify-content: center; gap: 16px; font-size: 14px; color: #57564F; flex-wrap: wrap;">
          <time datetime={yazi.data.tarih.toISOString()}>
            {new Date(yazi.data.tarih).toLocaleDateString('tr-TR', { year: 'numeric', month: 'long', day: 'numeric' })}
          </time>
          <span style="width: 4px; height: 4px; background: #57564F; border-radius: 50%;"></span>
          <span style="display: flex; align-items: center; gap: 4px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            {okumaSuresi} dk okuma
          </span>
          {yazi.data.yazar && (
            <>
              <span style="width: 4px; height: 4px; background: #57564F; border-radius: 50%;"></span>
              <span>{yazi.data.yazar}</span>
            </>
          )}
        </div>
        
        <!-- Etiketler -->
        {yazi.data.etiketler && yazi.data.etiketler.length > 0 && (
          <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 16px; flex-wrap: wrap;">
            {yazi.data.etiketler.map((etiket) => (
              <a 
                href={`/blog/etiket/${etiket.toLowerCase().replace(/\s+/g, '-')}`}
                style="font-size: 12px; padding: 4px 10px; background: #44444E; color: #D3DAD9; border-radius: 4px; text-decoration: none; transition: background 0.2s;"
                class="etiket-badge"
              >
                #{etiket}
              </a>
            ))}
          </div>
        )}
      </header>
      
      <!-- Kapak görseli -->
      {yazi.data.kapakGorseli && (
        <figure style="margin-bottom: 40px; border-radius: 12px; overflow: hidden;">
          <img 
            src={yazi.data.kapakGorseli} 
            alt={yazi.data.baslik}
            style="width: 100%; height: auto; object-fit: cover;"
            loading="eager"
          />
        </figure>
      )}
      
      <!-- Ana içerik alanı -->
      <div style="display: flex; gap: 40px;">
        
        <!-- Sol: İçindekiler (Desktop) -->
        {headings.length > 2 && (
          <aside class="toc-sidebar" style="width: 220px; flex-shrink: 0;">
            <div style="position: sticky; top: 100px;">
              <TableOfContents headings={headings} />
            </div>
          </aside>
        )}
        
        <!-- Sağ: İçerik -->
        <div style="flex: 1; min-width: 0; max-width: 750px;">
          
          <!-- Mobil İçindekiler -->
          {headings.length > 2 && (
            <details class="toc-mobile" style="background: #44444E; border-radius: 8px; padding: 16px; margin-bottom: 32px;">
              <summary style="cursor: pointer; font-weight: 500; color: #D3DAD9; list-style: none; display: flex; align-items: center; gap: 8px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
                </svg>
                İçindekiler
              </summary>
              <div style="margin-top: 12px;">
                <TableOfContents headings={headings} mobile={true} />
              </div>
            </details>
          )}
          
          <!-- İçerik -->
          <div class="prose">
            <Content />
          </div>
          
          <!-- Sosyal paylaşım -->
          <div style="margin-top: 48px; padding-top: 32px; border-top: 1px solid #44444E;">
            <ShareButtons 
              title={yazi.data.baslik}
              url={Astro.url.href}
            />
          </div>
          
          <!-- Yazar kutusu -->
          <div style="margin-top: 32px; padding: 24px; background: #44444E; border-radius: 12px; display: flex; align-items: flex-start; gap: 16px;">
            <img 
              src="/images/osman-tasdemir.jpg" 
              alt="Osman Taşdemir"
              style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover; flex-shrink: 0;"
              onerror="this.style.display='none'"
            />
            <div>
              <h3 style="font-size: 16px; font-weight: 600; color: #D3DAD9; margin: 0 0 4px 0;">Osman Taşdemir</h3>
              <p style="font-size: 14px; color: #57564F; margin: 0 0 8px 0;">CBS Uzmanı & Otomasyon Geliştiricisi</p>
              <p style="font-size: 14px; color: #D3DAD9; opacity: 0.7; margin: 0; line-height: 1.5;">
                İzmir Bakırçay Üniversitesi Coğrafya bölümü. CBS, uzaktan algılama ve otomasyon alanlarında çalışıyorum.
              </p>
            </div>
          </div>
          
          <!-- İlgili yazılar -->
          <RelatedPosts 
            currentSlug={yazi.slug}
            currentKategori={yazi.data.kategori}
            tumYazilar={tumYazilar}
          />
          
          <!-- Yorumlar -->
          <Comments pageId={yazi.slug} pageTitle={yazi.data.baslik} />
          
          <!-- Geri dön butonu -->
          <div style="margin-top: 48px; padding-top: 32px; border-top: 1px solid #44444E;">
            <a href="/blog" style="display: inline-flex; align-items: center; gap: 8px; color: #D3DAD9; text-decoration: none; padding: 12px 24px; background: #57564F; border-radius: 8px; transition: background 0.2s;" class="back-btn">
              ← Tüm Yazılar
            </a>
          </div>
          
        </div>
      </div>
      
    </article>
  </main>
</Layout>

<style>
  /* Başlık linklerini normal göster */
.prose :global(h2 a),
.prose :global(h3 a),
.prose :global(h4 a) {
  color: inherit;
  text-decoration: none;
  border-bottom: none;
}

.prose :global(h2 a:hover),
.prose :global(h3 a:hover),
.prose :global(h4 a:hover) {
  color: inherit;
  border-bottom: none;
}
  /* TOC sidebar sadece desktop'ta */
  .toc-sidebar {
    display: none;
  }
  
  @media (min-width: 1024px) {
    .toc-sidebar {
      display: block;
    }
    .toc-mobile {
      display: none !important;
    }
  }
  
  /* Hover efektleri */
  .kategori-badge:hover {
    background: #6a6960 !important;
  }
  
  .etiket-badge:hover {
    background: #57564F !important;
  }
  
  .back-btn:hover {
    background: #6a6960 !important;
  }
  
  /* Prose stilleri */
  .prose {
    color: #D3DAD9;
    font-size: 17px;
    line-height: 1.8;
  }
  
  .prose :global(h2) {
  font-size: 28px;
  font-weight: 700;
  margin-top: 56px;
  margin-bottom: 20px;
  color: #fff;
  scroll-margin-top: 100px;
  padding-bottom: 12px;
  border-bottom: 1px solid rgba(87, 86, 79, 0.3);
}
  
  .prose :global(h3) {
    font-size: 21px;
    font-weight: 600;
    margin-top: 36px;
    margin-bottom: 12px;
    color: #D3DAD9;
    scroll-margin-top: 100px;
  }
  
  .prose :global(h4) {
    font-size: 18px;
    font-weight: 600;
    margin-top: 28px;
    margin-bottom: 10px;
    color: #D3DAD9;
    scroll-margin-top: 100px;
  }
  
  .prose :global(p) {
    margin-bottom: 20px;
    opacity: 0.9;
  }
  
  .prose :global(strong) {
    font-weight: 700;
    color: #fff;
  }
  
  .prose :global(em) {
    font-style: italic;
  }
  
  .prose :global(ul), .prose :global(ol) {
    margin-bottom: 20px;
    padding-left: 24px;
  }
  
  .prose :global(ul) {
    list-style-type: disc;
  }
  
  .prose :global(ol) {
    list-style-type: decimal;
  }
  
  .prose :global(li) {
    margin-bottom: 8px;
  }
  
  .prose :global(li > ul), .prose :global(li > ol) {
    margin-top: 8px;
    margin-bottom: 8px;
  }
  
  .prose :global(a) {
    color: #8ab4f8;
    text-decoration: underline;
    text-underline-offset: 2px;
    transition: color 0.2s;
  }
  
  .prose :global(a:hover) {
    color: #aecbfa;
  }
  
  /* Inline kod */
  .prose :global(code:not(pre code)) {
    background: #44444E;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.9em;
    font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
  }
  
  /* Kod blokları */
  .prose :global(pre) {
    background: #1a1a1a !important;
    padding: 20px;
    border-radius: 8px;
    overflow-x: auto;
    margin-bottom: 24px;
    position: relative;
  }
  
  .prose :global(pre code) {
    font-size: 14px;
    line-height: 1.6;
    font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
  }
  
  /* Blockquote */
  .prose :global(blockquote) {
  border-left: 4px solid #7c9a5e;
  padding: 20px 24px;
  margin: 32px 0;
  background: linear-gradient(135deg, rgba(124, 154, 94, 0.1) 0%, rgba(124, 154, 94, 0.05) 100%);
  border-radius: 0 12px 12px 0;
  font-style: italic;
  color: #b8b8b8;
}
  
  .prose :global(blockquote p) {
    margin-bottom: 0;
  }
  
  /* Tablolar - GFM */
  .prose :global(table) {
  width: 100%;
  margin: 32px 0;
  border-collapse: collapse;
  font-size: 15px;
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid rgba(87, 86, 79, 0.3);
}

.prose :global(thead) {
  background: linear-gradient(135deg, #3a3a42 0%, #2d2d35 100%);
}

.prose :global(th) {
  padding: 14px 18px;
  text-align: left;
  font-weight: 600;
  color: #D3DAD9;
  border-bottom: 2px solid rgba(87, 86, 79, 0.5);
}

.prose :global(td) {
  padding: 14px 18px;
  border-bottom: 1px solid rgba(87, 86, 79, 0.2);
  color: #b8b8b8;
}

.prose :global(tr:hover td) {
  background: rgba(87, 86, 79, 0.15);
}
  
  /* Görseller */
  .prose :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 24px 0;
  }
  
  .prose :global(figure) {
    margin: 24px 0;
  }
  
  .prose :global(figcaption) {
    text-align: center;
    font-size: 14px;
    color: #57564F;
    margin-top: 8px;
  }
  
  /* Yatay çizgi */
  .prose :global(hr) {
    border: none;
    border-top: 1px solid #44444E;
    margin: 40px 0;
  }
  
  /* Tasklist (GFM) */
  .prose :global(input[type="checkbox"]) {
    margin-right: 8px;
  }
  
  /* Strikethrough (GFM) */
  .prose :global(del) {
    opacity: 0.6;
  }
</style>

<script is:inline>
  // Okuma ilerleme çubuğu
  const progressBar = document.getElementById('progress-bar');
  
  window.addEventListener('scroll', () => {
    const scrollTop = window.scrollY;
    const docHeight = document.documentElement.scrollHeight - window.innerHeight;
    const progress = (scrollTop / docHeight) * 100;
    
    if (progressBar) {
      progressBar.style.width = `${Math.min(progress, 100)}%`;
    }
  });
  
  // Kod kopyalama butonları ekle
  document.querySelectorAll('.prose pre').forEach((pre) => {
    // Container oluştur
    const wrapper = document.createElement('div');
    wrapper.style.position = 'relative';
    pre.parentNode.insertBefore(wrapper, pre);
    wrapper.appendChild(pre);
    
    // Buton oluştur
    const button = document.createElement('button');
    button.textContent = 'Kopyala';
    button.style.cssText = 'position: absolute; top: 8px; right: 8px; padding: 6px 12px; background: #44444E; border: none; border-radius: 4px; color: #D3DAD9; font-size: 12px; cursor: pointer; opacity: 0; transition: opacity 0.2s, background 0.2s;';
    
    wrapper.addEventListener('mouseenter', () => {
      button.style.opacity = '1';
    });
    
    wrapper.addEventListener('mouseleave', () => {
      button.style.opacity = '0';
    });
    
    button.addEventListener('click', async () => {
      const code = pre.querySelector('code');
      if (code) {
        try {
          await navigator.clipboard.writeText(code.textContent || '');
          button.textContent = 'Kopyalandı!';
          button.style.background = '#22c55e';
          setTimeout(() => {
            button.textContent = 'Kopyala';
            button.style.background = '#44444E';
          }, 2000);
        } catch (err) {
          console.error('Kopyalama başarısız:', err);
        }
      }
    });
    
    button.addEventListener('mouseenter', () => {
      button.style.background = '#57564F';
    });
    
    button.addEventListener('mouseleave', () => {
      button.style.background = '#44444E';
    });
    
    wrapper.appendChild(button);
  });
</script>
